{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Pullups Tracker â€” Offline Coins + Chest Shop (Settings) with Premium Animations",
  "requirements": [
    {
      "id": "REQ-51",
      "summary": "Extend offline IndexedDB storage to persist Coins, chest opening history, and card wallet/inventory without impacting existing stores.",
      "acceptanceCriteria": [
        "Coins balance persists across refreshes and browser restarts.",
        "Each opened chest is stored in a chest history list with timestamp, chest type, coin cost, and the revealed card values for that chest.",
        "Each revealed card is stored in a wallet/inventory list with timestamp, chest type, and value.",
        "Existing stored data (sessions/settings/quality/milestones/achievements) remains intact and readable after the update."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/offlineDb.ts",
          "operation": "modify",
          "description": "Add new IndexedDB stores and migration for coins balance, chest history, and card wallet; add read/write helper methods while preserving existing stores and data."
        },
        {
          "path": "frontend/src/lib/types.ts",
          "operation": "modify",
          "description": "Add TypeScript types for Coins state, ChestOpen record, and CardWallet item; extend settings types only as needed for chest modifiers defaults (no keyboard-driven inputs)."
        },
        {
          "path": "frontend/src/lib/economy/chestsTypes.ts",
          "operation": "create",
          "description": "Define chest tiers (Common/Rare/Epic), costs, draw counts, and persisted record shapes for history/wallet."
        },
        {
          "path": "frontend/src/lib/economy/economyStore.ts",
          "operation": "create",
          "description": "Centralize offline economy operations (get/set coins, append chest history, append wallet items) via offlineDb to keep the rest of the app decoupled."
        }
      ]
    },
    {
      "id": "REQ-52",
      "summary": "Include coins, chest history, and card wallet in Settings Backup & Restore export/import with backward compatibility.",
      "acceptanceCriteria": [
        "Exported backup JSON includes coins balance, chest history, and card wallet/inventory in addition to existing data.",
        "Importing an older backup (missing coins/chests/cards) completes successfully and initializes coins/chests/cards to empty/default values.",
        "Importing a newer backup restores coins/chests/cards exactly (counts, timestamps, and values).",
        "Backup & Restore UI remains in Settings and continues to show success/failure states."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/offlineDb.ts",
          "operation": "modify",
          "description": "Extend exportData/importData to include coins, chestHistory, and cardWallet; keep backward compatibility by defaulting missing fields on import."
        },
        {
          "path": "frontend/src/lib/backup.ts",
          "operation": "modify",
          "description": "Ensure backup helpers continue to export/import through offlineDb while surfacing any new validation errors cleanly (no new navigation or keyboard UI)."
        },
        {
          "path": "frontend/src/components/BackupRestorePanel.tsx",
          "operation": "modify",
          "description": "Keep Settings Backup & Restore UX intact while confirming success/failure states still work with the expanded backup payload."
        }
      ]
    },
    {
      "id": "REQ-53",
      "summary": "Award coins fully offline during session save flow based on performance, milestones, streak changes/bonuses, and achievements unlocks.",
      "acceptanceCriteria": [
        "Coins increase automatically as part of the Log save flow (no extra user action required).",
        "Coins can also increase when milestones are detected and when achievements unlock (in the same offline flow).",
        "Awarding coins never blocks or breaks existing flows (session save, milestone overlay, achievement popups, rank promotion, PR celebration, quality overlay).",
        "All coin events work fully offline."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/economy/coinRewards.ts",
          "operation": "create",
          "description": "Implement deterministic, offline-only coin reward calculation based on session performance signals already computed in the Log flow (reps/quality/milestones/streak/achievements)."
        },
        {
          "path": "frontend/src/lib/economy/economyService.ts",
          "operation": "create",
          "description": "Implement a small service that applies calculated coin rewards to persisted balance, emitting an in-app event payload usable by UI feedback (no network)."
        },
        {
          "path": "frontend/src/screens/LogScreen.tsx",
          "operation": "modify",
          "description": "Hook coin awarding into the existing session save flow after session/quality/milestones/achievements are computed; ensure it never blocks existing overlays/popups and works offline."
        },
        {
          "path": "frontend/src/hooks/usePullupStore.tsx",
          "operation": "modify",
          "description": "Expose current coins balance and a way for screens/components to refresh it after offline updates, without changing existing session/settings behavior."
        }
      ]
    },
    {
      "id": "REQ-54",
      "summary": "Add animated coin balance UI to Dashboard top-right with rolling counter and glow burst on increases.",
      "acceptanceCriteria": [
        "Dashboard shows a clearly visible coin balance in the top-right corner.",
        "Coin value changes animate smoothly (rolling/counting effect).",
        "When coins increase, the coin UI plays a subtle glow/highlight animation without impacting other Dashboard animations.",
        "No keyboard input is introduced."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/coins/CoinBalanceBadge.tsx",
          "operation": "create",
          "description": "Create a compact top-right coin badge using the existing RollingCounter for smooth value transitions and a lightweight glow burst animation on increases."
        },
        {
          "path": "frontend/src/screens/DashboardScreen.tsx",
          "operation": "modify",
          "description": "Wire CoinBalanceBadge into the Dashboard layout (top-right) without altering existing rank/orb/rings/flame/pressure behaviors and keeping animations smooth."
        },
        {
          "path": "frontend/src/index.css",
          "operation": "modify",
          "description": "Add minimal CSS keyframes/utilities for coin increase glow burst that aligns with the existing cold luxury palette and avoids heavy effects impacting ~60fps."
        },
        {
          "path": "frontend/src/assets/generated.ts",
          "operation": "modify",
          "description": "Add generated asset path export for the coin icon at frontend/public/assets/generated/coin-icon.dim_128x128.png so the Dashboard coin UI can display it."
        },
        {
          "path": "frontend/public/assets/generated/coin-icon.dim_128x128.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/coin-icon.dim_128x128.png."
        }
      ]
    },
    {
      "id": "REQ-55",
      "summary": "Add a Chest Shop section inside Settings showing coin balance, chest options with costs, and scrollable chest history while preserving existing Settings panels.",
      "acceptanceCriteria": [
        "Settings contains a new Chest Shop panel/section while keeping all existing panels present and functional.",
        "Chest Shop section shows current coin balance.",
        "Chest Shop section lists three chest types with clear costs: Common 250, Rare 500, Epic 1000.",
        "Chest Shop section shows a scrollable history of opened chests (most recent first) with timestamp and results."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/chests/ChestShopPanel.tsx",
          "operation": "create",
          "description": "Create a Settings panel for Chest Shop using shadcn-ui primitives (e.g., Button/Dialog/Separator/ScrollArea/Switch where appropriate) to display coin balance, three chest options, and history. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/screens/SettingsScreen.tsx",
          "operation": "modify",
          "description": "Insert the new ChestShopPanel into the existing Settings screen while keeping Volume Control, Daily Goal, Backup & Restore, and Danger Zone panels intact and functional."
        },
        {
          "path": "frontend/src/assets/generated.ts",
          "operation": "modify",
          "description": "Add generated asset path exports for chest illustrations: frontend/public/assets/generated/chest-common.dim_512x512.png, frontend/public/assets/generated/chest-rare.dim_512x512.png, frontend/public/assets/generated/chest-epic.dim_512x512.png."
        },
        {
          "path": "frontend/public/assets/generated/chest-common.dim_512x512.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/chest-common.dim_512x512.png."
        },
        {
          "path": "frontend/public/assets/generated/chest-rare.dim_512x512.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/chest-rare.dim_512x512.png."
        },
        {
          "path": "frontend/public/assets/generated/chest-epic.dim_512x512.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/chest-epic.dim_512x512.png."
        }
      ]
    },
    {
      "id": "REQ-56",
      "summary": "Implement chest purchase/open flow with confirm, immediate coin deduction, premium opening animation, sequential card reveals, and offline persistence to wallet/history.",
      "acceptanceCriteria": [
        "Attempting to open a chest with insufficient coins is blocked with a clear error/toast and no state changes.",
        "On confirmation, coins are deducted immediately and the UI reflects the new balance.",
        "A chest-opening overlay/modal sequence plays before card results are fully shown.",
        "Cards are revealed sequentially (not all at once) with a flip/slide animation and a highlight glow.",
        "After completion, the revealed cards are persisted into the offline wallet and the chest opening is appended to history."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "create",
          "description": "Implement the chest open confirm + animation overlay flow using shadcn-ui Dialog (and buttons) with no text inputs; orchestrate shake/glow then sequential card reveal steps. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/chests/CardReveal.tsx",
          "operation": "create",
          "description": "Create a premium card reveal component (flip/slide + highlight glow) that can be driven sequentially by the chest opening flow; uses generated card frame/back assets. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/chests/ChestShopPanel.tsx",
          "operation": "modify",
          "description": "Wire chest selection to open ChestOpenDialog; on confirm, validate coins, deduct immediately, then run opening sequence and refresh balance/history UI."
        },
        {
          "path": "frontend/src/lib/economy/chestOpenFlow.ts",
          "operation": "create",
          "description": "Implement the core chest opening transaction logic (check balance, deduct, draw cards, persist wallet + history) as an offline-only function callable from UI."
        },
        {
          "path": "frontend/src/index.css",
          "operation": "modify",
          "description": "Add CSS animations for chest shake, tier glow, aura sweep, and card flip/slide reveal with performance-friendly keyframes (no layout thrash)."
        },
        {
          "path": "frontend/src/assets/generated.ts",
          "operation": "modify",
          "description": "Add generated asset path exports for card visuals: frontend/public/assets/generated/card-frame.dim_600x840.png and frontend/public/assets/generated/card-back.dim_600x840.png."
        },
        {
          "path": "frontend/public/assets/generated/card-frame.dim_600x840.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/card-frame.dim_600x840.png."
        },
        {
          "path": "frontend/public/assets/generated/card-back.dim_600x840.png",
          "operation": "create",
          "description": "Add the generated image asset file (wired via frontend/src/assets/generated.ts): frontend/public/assets/generated/card-back.dim_600x840.png."
        }
      ]
    },
    {
      "id": "REQ-57",
      "summary": "Implement exact independent probabilistic draw tables per chest type with correct draw counts and duplicates allowed.",
      "acceptanceCriteria": [
        "Common chest: 3 independent draws; each draw uses: 10rs=20%, 20rs=30%, 30rs=50%.",
        "Rare chest: 5 independent draws; each draw uses: 20rs=10%, 40rs=15%, 60rs=20%, 80rs=25%, 100rs=30%.",
        "Epic chest: 7 independent draws; each draw uses: 50rs=25%, 80rs=30%, 100rs=20%, 120rs=30% total (15%+15% treated as 120rs), 150rs=30% total (5%+5%+5% treated as 150rs), 180rs=10% total (5%+5% treated as 180rs).",
        "Within a single chest opening, the same value can appear multiple times (no uniqueness constraint).",
        "The app always produces exactly 3/5/7 card values for Common/Rare/Epic respectively."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/economy/drawTables.ts",
          "operation": "create",
          "description": "Encode the exact base probability tables per chest tier and provide a reusable weighted-draw helper where each draw is independent and duplicates are allowed."
        },
        {
          "path": "frontend/src/lib/economy/drawCards.ts",
          "operation": "create",
          "description": "Implement draw logic that returns exactly 3/5/7 values for Common/Rare/Epic respectively, using the base tables (and later modifiers) with independent draws."
        },
        {
          "path": "frontend/src/lib/economy/chestOpenFlow.ts",
          "operation": "modify",
          "description": "Use the drawCards helper to generate revealed values per chest tier and persist the resulting values exactly as drawn."
        }
      ]
    },
    {
      "id": "REQ-58",
      "summary": "Apply tier-based chest styling/effects matching the luxury cold aesthetic with distinct Common/Rare/Epic identities and opening effects.",
      "acceptanceCriteria": [
        "Chest Shop UI uses glass morphism panels, depth shadows, and minimal futuristic styling consistent with the rest of the app.",
        "Common chest visuals read as bronze with a soft glow.",
        "Rare chest visuals read as silver with a shimmering aura effect.",
        "Epic chest visuals read as gold/amber with animated particles and an aura sweep during opening/reveal.",
        "No existing RankBadge/Orb/Stickman/WheelPicker styling is removed or degraded."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/chests/ChestTile.tsx",
          "operation": "create",
          "description": "Create a chest option tile component that renders tier-specific visuals (bronze/silver/gold-amber) and supports hover/tap effects without breaking wheel-only UX; uses generated chest images. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/chests/ChestShopPanel.tsx",
          "operation": "modify",
          "description": "Use ChestTile for Common/Rare/Epic options and ensure the panel styling matches existing glass cards and palette (#0b0f14 background vibe, #00f0ff accents)."
        },
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "modify",
          "description": "Add tier-specific opening/reveal effects: Common soft glow, Rare shimmer aura, Epic particles + aura sweep during opening/reveal sequence."
        },
        {
          "path": "frontend/src/index.css",
          "operation": "modify",
          "description": "Add tier effect styles (bronze glow, silver shimmer, epic particle + aura sweep) using lightweight CSS animations consistent with existing luxury cold aesthetic."
        }
      ]
    },
    {
      "id": "REQ-59",
      "summary": "Extend global SFX system for chest opening and per-card reveal sounds (tier-specific + special high-value feedback) controlled by existing volume setting.",
      "acceptanceCriteria": [
        "New chest SFX can be played via the existing global volume control.",
        "Common chest opening plays the specified soft metallic click-style SFX.",
        "Rare chest opening plays the specified sparkle/jingle-style SFX.",
        "Epic chest opening plays the specified epic deep pulse/bass + shimmer-style SFX.",
        "Each card reveal plays a short reveal sound; high-value reveals trigger stronger/unique audio feedback without overlapping excessively or breaking other SFX."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/sfx.ts",
          "operation": "modify",
          "description": "Add new SfxType entries and sound file mappings for chest-common-open, chest-rare-open, chest-epic-open, card-reveal, card-reveal-high, and coin-award; keep existing volume handling unchanged."
        },
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "modify",
          "description": "Wire tier-specific opening SFX and per-card reveal SFX using the existing useSfx hook, including a stronger unique sound for high-value reveals."
        },
        {
          "path": "frontend/src/components/coins/CoinBalanceBadge.tsx",
          "operation": "modify",
          "description": "Optionally play a subtle coin-award SFX on increases via useSfx while respecting the global volume control."
        },
        {
          "path": "frontend/public/assets/sfx/chest-common-open.mp3",
          "operation": "create",
          "description": "Add a soft metallic click-style SFX file for Common chest opening at frontend/public/assets/sfx/chest-common-open.mp3."
        },
        {
          "path": "frontend/public/assets/sfx/chest-rare-open.mp3",
          "operation": "create",
          "description": "Add a sparkle/jingle-style SFX file for Rare chest opening at frontend/public/assets/sfx/chest-rare-open.mp3."
        },
        {
          "path": "frontend/public/assets/sfx/chest-epic-open.mp3",
          "operation": "create",
          "description": "Add an epic deep pulse/bass + shimmer SFX file for Epic chest opening at frontend/public/assets/sfx/chest-epic-open.mp3."
        },
        {
          "path": "frontend/public/assets/sfx/card-reveal.mp3",
          "operation": "create",
          "description": "Add a short per-card reveal SFX file at frontend/public/assets/sfx/card-reveal.mp3."
        },
        {
          "path": "frontend/public/assets/sfx/card-reveal-high.mp3",
          "operation": "create",
          "description": "Add a stronger unique SFX file for high-value reveals at frontend/public/assets/sfx/card-reveal-high.mp3."
        },
        {
          "path": "frontend/public/assets/sfx/coin-award.mp3",
          "operation": "create",
          "description": "Add a subtle coin award SFX file at frontend/public/assets/sfx/coin-award.mp3."
        }
      ]
    },
    {
      "id": "REQ-60",
      "summary": "Add subtle coin award feedback (animation + haptics) and stronger tier/high-value feedback during chest opening while degrading gracefully without vibration support.",
      "acceptanceCriteria": [
        "Coin award events trigger a subtle UI feedback (e.g., glow/pulse on coin counter) and a light/appropriate haptic where supported.",
        "Opening a chest triggers a stronger but premium feedback moment (visual + optional haptic) aligned with the tier.",
        "High-value card reveals trigger a noticeably stronger effect than normal reveals (visual + sound; haptic where supported).",
        "No keyboard input is introduced."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/coins/CoinBalanceBadge.tsx",
          "operation": "modify",
          "description": "Trigger a subtle pulse/glow animation and light haptic (via existing haptics utility) when the balance increases, without affecting other Dashboard animations."
        },
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "modify",
          "description": "Trigger tier-aligned haptics on chest open confirmation/opening and stronger haptics on high-value card reveals while gracefully handling devices without vibration."
        },
        {
          "path": "frontend/src/lib/haptics.ts",
          "operation": "modify",
          "description": "If needed, add a minimal additional pattern mapping for chest moments while preserving existing patterns and behavior; keep graceful degradation when vibration is unsupported."
        },
        {
          "path": "frontend/src/index.css",
          "operation": "modify",
          "description": "Add/adjust CSS utilities for subtle positive feedback pulses and stronger highlight effects for special reveals, staying within the existing palette and performance expectations."
        }
      ]
    },
    {
      "id": "REQ-61",
      "summary": "Preserve all existing app functionality, wheel-only UX, styling, and performance while integrating the new offline economy features.",
      "acceptanceCriteria": [
        "All existing screens and features remain accessible and function as before.",
        "No regressions to wheel picker behavior, stickman slider scroll-lock, rank badge animations, or existing SFX/haptics.",
        "Chest/coin animations remain smooth and do not cause noticeable lag on typical mobile devices.",
        "Everything works offline; no new network dependencies are introduced for core functionality."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/chests/ChestShopPanel.tsx",
          "operation": "modify",
          "description": "Audit interactions to ensure no text inputs are introduced and no new navigation tabs/routes are added; ensure all actions are tap-based and consistent with existing UX."
        },
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "modify",
          "description": "Ensure animation sequencing uses lightweight transitions and avoids heavy re-renders; keep overlays compatible with existing focus/scroll behavior."
        },
        {
          "path": "frontend/src/screens/DashboardScreen.tsx",
          "operation": "modify",
          "description": "Ensure coin UI integration does not disrupt existing layout/animations; keep updates efficient to preserve smooth ~60fps."
        }
      ]
    },
    {
      "id": "REQ-62",
      "summary": "Add optional chest modifiers (streak bonus, daily first-chest bonus) with Settings controls, transparent active indicators, and offline persistence (defaults off).",
      "acceptanceCriteria": [
        "Chest Shop UI provides toggles/controls for enabling/disabling chest streak bonus and daily first-chest bonus.",
        "When disabled, chest outcomes follow the base probability tables exactly.",
        "When enabled, the bonus rules apply consistently and transparently (the UI indicates when a bonus is active for an opening).",
        "Bonus state and relevant counters/timestamps persist offline across refreshes."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/economy/modifiers.ts",
          "operation": "create",
          "description": "Define modifier rules, persisted modifier state (toggles + counters/timestamps), and logic to compute when bonuses are active for a given opening."
        },
        {
          "path": "frontend/src/lib/economy/drawCards.ts",
          "operation": "modify",
          "description": "Apply optional modifier logic only when enabled; guarantee base tables are used exactly when modifiers are off."
        },
        {
          "path": "frontend/src/lib/offlineDb.ts",
          "operation": "modify",
          "description": "Persist modifier toggle state and any required counters/timestamps in offline storage alongside coins/chest history/card wallet (defaults off on first run / old backups)."
        },
        {
          "path": "frontend/src/components/chests/ChestShopPanel.tsx",
          "operation": "modify",
          "description": "Add on/off controls for streak bonus and daily first-chest bonus using shadcn-ui Switch/Label and indicate when a bonus is active for an opening. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/components/chests/ChestOpenDialog.tsx",
          "operation": "modify",
          "description": "Display a clear, non-text-input indicator during opening when a modifier is active (streak/daily), and ensure it affects only the current opening as specified."
        }
      ]
    }
  ]
}